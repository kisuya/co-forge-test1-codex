name: ci-release-gate

on:
  pull_request:
  push:
    branches:
      - main
    tags:
      - "v*.*.*"

jobs:
  api-worker-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Python syntax gate
        run: |
          python3 -m py_compile $(git ls-files "apps/**/*.py" "tests/**/*.py")
      - name: API/worker test gate
        run: ./.forge/scripts/test_fast.sh

  web-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: Install web dependencies
        run: |
          corepack enable
          pnpm --dir apps/web install --no-frozen-lockfile
      - name: Web typecheck
        run: pnpm --dir apps/web exec tsc --noEmit
      - name: Web unit tests
        run: pnpm --dir apps/web test

  e2e-tests:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Playwright
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install playwright
          python3 -m playwright install chromium
      - name: Run core E2E scenarios
        env:
          RUN_E2E: "1"
        run: |
          python3 -m unittest tests.e2e.test_core_user_journey tests.e2e.test_retryable_error_ux

  release-checklist-gate:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs:
      - api-worker-tests
      - web-tests
      - e2e-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Validate beta release checklist
        run: |
          python3 scripts/validate_release_checklist.py docs/release/beta-release-checklist.json
